<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navbar H·ªá th·ªëng t·ªï ch·ª©c thi ch·ª©ng ch·ªâ</title>
    <link rel="stylesheet" href="/CSS/TraCuuPhieuGiaHan.css">
    <link rel="stylesheet" href="/CSS/Navbar.css">
</head>
<body>
    <div id="navbar-container"></div>
    <h1>Tra C·ª©u Phi·∫øu Gia H·∫°n</h1>
    <input type="text" id="search-box" placeholder="Nh·∫≠p CCCD">
    <button id="search-btn" onclick="fetchData()">üîç</button>

    <!-- <input type="text" id="search-box" placeholder="Nh·∫≠p CCCD">
    <button id="search-btn">üîç</button> -->
    
    <table>
        <thead>
            <tr>
                <th>CCCD</th>
                <th>Phi·∫øu ƒëƒÉng k√Ω</th>
                <th>Lo·∫°i gia h·∫°n</th>
                <th>Ph√≠ gia h·∫°n</th>
                <th>L√≠ do gia h·∫°n</th>
                <th>Ng√†y Thi C≈©</th>
                <th>Ng√†y Thi M·ªõi</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã t·∫°i ƒë√¢y b·∫±ng JavaScript -->
        </tbody>
    </table>
    <button class="btn_Tra_cuu_SLGH" onclick="window.location.href='TraCuuSoLanGiaHan.html'">
        Tra c·ª©u s·ªë l·∫ßn gia h·∫°n
    </button>
    <button class="btn_Lap_Phieu_Gia_Han" onclick="window.location.href='LapPhieuGiaHan.html'">
        L·∫≠p phi·∫øu gia h·∫°n
    </button>

    <script src="/DangNhap/Navbar.js"></script>
    <script src="/GiaHan/GiaHan.js"></script>
    <script>
        async function fetchData() {
            const cccd = document.getElementById('search-box').value.trim();
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // X√≥a d·ªØ li·ªáu c≈©

            if (!cccd) {
                alert('Vui l√≤ng nh·∫≠p CCCD!');
                return;
            }

            try {
                const response = await fetch(`/api/getPhieuGiaHan?cccd=${cccd}`);
                const data = await response.json();

                // Tr∆∞·ªùng h·ª£p l·ªói t·ª´ backend (v√≠ d·ª•: RAISERROR t·ª´ SQL Server)
                if (!response.ok || data.error) {
                    tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">${data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}</td></tr>`;
                    return;
                }

                // Tr∆∞·ªùng h·ª£p kh√¥ng c√≥ d·ªØ li·ªáu
                if (data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</td></tr>`;
                    return;
                }

                // Tr∆∞·ªùng h·ª£p c√≥ d·ªØ li·ªáu, hi·ªÉn th·ªã
                const rows = data.map(item => `
                    <tr>
                        <td>${item.CCCD}</td>
                        <td>${item.MaPhieuDangKy}</td>
                        <td>${item.LoaiGiaHan}</td>
                        <td>${item.PhiGiaHan}</td>
                        <td>${item.LiDoGiaHan}</td>
                        <td>${new Date(item.NTC).toLocaleDateString('vi-VN')}</td>
                        <td>${new Date(item.NTM).toLocaleDateString('vi-VN')}</td>
                        <td>
                            <button class="edit-btn" onclick="editRow('${item.CCCD}', ${item.MaPhieuDangKy})">S·ª≠a</button>
                            <button class="delete-btn" onclick="deleteRow('${item.CCCD}', ${item.MaPhieuDangKy})">X√≥a</button>
                        </td>
                    </tr>
                `).join('');

                tableBody.innerHTML = rows;

            } catch (error) {
                console.error('L·ªói khi fetch d·ªØ li·ªáu:', error);
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">L·ªói khi k·∫øt n·ªëi t·ªõi m√°y ch·ªß.</td></tr>`;
            }
        }
        async function deleteRow(CCCD, MaPhieuDangKy) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a phi·∫øu gia h·∫°n n√†y kh√¥ng?')) return;

            try {
                const response = await fetch('/api/deletePhieuGiaHan', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ CCCD, MaPhieuDangKy })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    alert('Kh√¥ng th·ªÉ x√≥a phi·∫øu gia h·∫°n: ' + (result.message || 'L·ªói m√°y ch·ªß'));
                    return;
                }

                const escapedCCCD = CCCD.replace(/'/g, "\\'");
                const row = document.querySelector(
                    `button[onclick="deleteRow('${escapedCCCD}', ${MaPhieuDangKy})"]`
                )?.closest('tr');

                if (row) row.remove();

                alert('ƒê√£ x√≥a phi·∫øu gia h·∫°n th√†nh c√¥ng!');
            } catch (err) {
                console.error(err);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a phi·∫øu gia h·∫°n.');
            }
        }

    </script>
</body>
</html>