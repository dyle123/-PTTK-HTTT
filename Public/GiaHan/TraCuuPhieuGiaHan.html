<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navbar H·ªá th·ªëng t·ªï ch·ª©c thi ch·ª©ng ch·ªâ</title>
    <link rel="stylesheet" href="/CSS/TraCuuPhieuGiaHan.css">
    <link rel="stylesheet" href="/CSS/Navbar.css">
</head>
<body>
    <div id="navbar-container"></div>
    <h1>Tra C·ª©u Phi·∫øu Gia H·∫°n</h1>
    <input type="text" id="search-box" placeholder="Nh·∫≠p CCCD">
    <input type="Date" id="date-box">
    <button id="search-btn" onclick="fetchData()">üîç</button>
    <h2>Vui l√≤ng nh·∫≠p th√¥ng tin ƒë·ªÉ tra c·ª©u</h2>
    <!-- <input type="text" id="search-box" placeholder="Nh·∫≠p CCCD">
    <button id="search-btn">üîç</button> -->
    
    <table>
        <thead>
            <tr>
                <th>CCCD</th>
                <th>M√£ Phi·∫øu ƒêƒÉng K√Ω</th>
                <th>Lo·∫°i Gia H·∫°n</th>
                <th>Ph√≠ Gia H·∫°n</th>
                <th>L√≠ Do Gia H·∫°n</th>
                <th>Ng√†y Thi C≈©</th>
                <th>Ng√†y Thi M·ªõi</th>
                <th>H√†nh ƒê·ªông</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã t·∫°i ƒë√¢y b·∫±ng JavaScript -->
        </tbody>
    </table>
    <button class="btn_Tra_cuu_SLGH" onclick="window.location.href='TraCuuSoLanGiaHan.html'">
        Tra c·ª©u s·ªë l·∫ßn gia h·∫°n
    </button>
    <button class="btn_Lap_Phieu_Gia_Han" onclick="window.location.href='LapPhieuGiaHan.html'">
        L·∫≠p phi·∫øu gia h·∫°n
    </button>

    <script src="/DangNhap/Navbar.js"></script>
    <script src="/GiaHan/GiaHan.js"></script>
    <script>
        window.onload = fetchData;
        async function fetchData() {
            const cccd = document.getElementById('search-box').value.trim();
            const date = document.getElementById("date-box").value;
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; // X√≥a d·ªØ li·ªáu c≈©

            try {
                const response = await fetch('/api/getPhieuGiaHan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({CCCD: cccd, NgayDuThi:date}),
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">${data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}</td></tr>`;
                    return;
                }

                if (data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</td></tr>`;
                    return;
                }

                const rows = data.map(item => `
                    <tr>
                        <td>${item.CCCD}</td>
                        <td>${item.MaPhieuDangKy}</td>
                        <td>${item.LoaiGiaHan}</td>
                        <td>${item.PhiGiaHan}</td>
                        <td>${item.LiDoGiaHan}</td>
                        <td>${new Date(item.NTC).toLocaleDateString('vi-VN')}</td>
                        <td>${new Date(item.NTM).toLocaleDateString('vi-VN')}</td>
                        <td>
                            <button class="edit-btn" onclick="editRow('${item.CCCD}', ${item.MaPhieuDangKy})">S·ª≠a</button>
                            <button class="delete-btn" onclick="deleteRow('${item.CCCD}', ${item.MaPhieuDangKy})">X√≥a</button>
                        </td>
                    </tr>
                `).join('');

                tableBody.innerHTML = rows;

            } catch (error) {
                console.error('L·ªói khi fetch d·ªØ li·ªáu:', error);
                tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">L·ªói khi k·∫øt n·ªëi t·ªõi m√°y ch·ªß.</td></tr>`;
            }
        }
        async function deleteRow(CCCD, MaPhieuDangKy) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a phi·∫øu gia h·∫°n n√†y kh√¥ng?')) return;

            try {
                const response = await fetch('/api/deletePhieuGiaHan', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ CCCD, MaPhieuDangKy })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    alert('Kh√¥ng th·ªÉ x√≥a phi·∫øu gia h·∫°n: ' + (result.message || 'L·ªói m√°y ch·ªß'));
                    return;
                }

                const escapedCCCD = CCCD.replace(/'/g, "\\'");
                const row = document.querySelector(
                    `button[onclick="deleteRow('${escapedCCCD}', ${MaPhieuDangKy})"]`
                )?.closest('tr');

                if (row) row.remove();

                alert('ƒê√£ x√≥a phi·∫øu gia h·∫°n th√†nh c√¥ng!');
            } catch (err) {
                console.error(err);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a phi·∫øu gia h·∫°n.');
            }
        }
        function editRow(CCCD, MaPhieuDangKy) {
            const row = document.querySelector(
                `button[onclick="editRow('${CCCD}', ${MaPhieuDangKy})"]`
            )?.closest('tr');

            if (!row) return;

            const cells = row.querySelectorAll('td');
            const values = Array.from(cells).map(cell => cell.textContent.trim());

            row.innerHTML = `
                <td><input value="${values[0]}" disabled></td>
                <td><input value="${values[1]}" disabled></td>
                <td>
                    <select>
                        <option value="H·ª£p l·ªá" ${values[2] === 'H·ª£p l·ªá' ? 'selected' : ''}>H·ª£p l·ªá</option>
                        <option value="Kh√¥ng h·ª£p l·ªá" ${values[2] === 'Kh√¥ng h·ª£p l·ªá' ? 'selected' : ''}>Kh√¥ng h·ª£p l·ªá</option>
                    </select>
                </td>
                <td><input type="number" value="${values[3]}"></td>
                <td><input value="${values[4]}"></td>
                <td><input type="date" value="${formatDateForInput(values[5])}"></td>
                <td><input type="date" value="${formatDateForInput(values[6])}"></td>
                <td>
                    <button onclick="saveRow('${CCCD}', ${MaPhieuDangKy}, this)">L∆∞u</button>
                     <button onclick="cancelEdit(this, ${MaPhieuDangKy}, '${CCCD}')">H·ªßy</button>
                </td>
            `;
        }
        async function saveRow(CCCD, MaPhieuDangKy, button) {
            const row = button.closest('tr');
            const inputs = row.querySelectorAll('input, select');

            const data = {
                CCCD,
                MaPhieuDangKy,
                LoaiGiaHan: inputs[2].value,
                PhiGiaHan: parseInt(inputs[3].value),
                LiDoGiaHan: inputs[4].value,
                NgayThiCu: inputs[5].value,
                NgayThiMoi: inputs[6].value,
            };

            try {
                const response = await fetch('/api/updatePhieuGiaHan', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t phi·∫øu gia h·∫°n: ' + (result.message || 'L·ªói m√°y ch·ªß'));
                    return;
                }

                alert('ƒê√£ c·∫≠p nh·∫≠t phi·∫øu gia h·∫°n th√†nh c√¥ng!');
                fetchData(); // Reload l·∫°i b·∫£ng
            } catch (err) {
                console.error(err);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t phi·∫øu gia h·∫°n.');
            }
        }

    function cancelEdit() 
        {
            fetchData(); // G·ªçi l·∫°i fetch ƒë·ªÉ reset b·∫£ng v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
        }
    function formatDateForInput(dateStr) 
        {
            const [day, month, year] = dateStr.split('/');
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

    </script>
</body>
</html>