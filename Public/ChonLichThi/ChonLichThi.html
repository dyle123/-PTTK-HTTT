<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªçn L·ªãch Thi</title>
    <link rel="stylesheet" href="/CSS/ChonLichThi.css">
    <script src="/DangNhap/Navbar.js"></script>
</head>

<body>
    <div id="navbar-container"></div>

    <h1>Danh S√°ch L·ªãch Thi</h1>

    <!-- B·ªô l·ªçc -->
    <div class="filter-container">
        <label><input type="radio" name="filter" id="filter-all" value="all" checked> T·∫•t c·∫£</label>
        <label><input type="radio" name="filter" value="ngaythi"> Ng√†y thi</label>
        <label><input type="radio" name="filter" value="giothi"> Gi·ªù thi</label>
        <label><input type="radio" name="filter" value="loaichungchi"> Lo·∫°i ch·ª©ng ch·ªâ</label>
        <input type="text" id="search-box" placeholder="T√¨m theo m√£ l·ªãch thi">
        <button id="search-btn">üîç</button>
    </div>

    <!-- B·∫£ng l·ªãch thi -->
    <table>
        <thead>
            <tr>
                <th>M√£ l·ªãch thi</th>
                <th>Ng√†y thi</th>
                <th>Gi·ªù thi</th>
                <th>S·ªë th√≠ sinh ƒë√£ ƒëƒÉng k√Ω</th>
                <th>M√£ ph√≤ng thi</th>
                <th>Lo·∫°i ch·ª©ng ch·ªâ</th>
                <th>Ch·ªçn</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <div class="submit-wrapper">
        <button id="btn-xac-nhan" class="submit-btn">X√°c nh·∫≠n ch·ªçn l·ªãch</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const radios = document.querySelectorAll("input[name='filter']");
            const searchBox = document.getElementById("search-box");
            const searchBtn = document.getElementById("search-btn");
            const tableBody = document.getElementById("table-body");

            async function fetchData(filter, searchValue = "") {
                try {
                    let url = new URL("http://localhost:3000/api/getLichThi");
                    let params = new URLSearchParams();

                    if (searchValue) {
                        params.append("maLichThi", searchValue);
                    } else if (filter && filter !== "all") {
                        params.append("dieuKien", filter);
                    }

                    url.search = params.toString();
                    const res = await fetch(url);
                    const data = await res.json();
                    renderTable(data);
                } catch (err) {
                    console.error("L·ªói fetch:", err);
                }
            }

            function renderTable(data) {
                tableBody.innerHTML = "";

                if (!Array.isArray(data) || data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Kh√¥ng c√≥ l·ªãch thi ph√π h·ª£p</td></tr>`;
                    return;
                }

                data.forEach(lich => {
                    if (lich.SoLuongDangKy >= 30) return;

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${lich.MaLichThi}</td>
                        <td>${lich.NgayThi}</td>
                        <td>${lich.GioThi}</td>
                        <td>${lich.SoLuongDangKy || 0}</td>
                        <td>${lich.MaPhongThi}</td>
                        <td>${lich.LoaiChungChi}</td>
                        <td>
                            <input type="radio" name="chon-lich" 
                                value="${lich.MaLichThi}" 
                                data-loaichungchi="${lich.LoaiChungChi}" 
                                data-thoigian="${lich.NgayThi}">
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            document.getElementById("btn-xac-nhan").addEventListener("click", async () => {
                const selected = document.querySelector("input[name='chon-lich']:checked");
                if (!selected) {
                    alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn m·ªôt l·ªãch thi!");
                    return;
                }

                const maPhieuDangKy = sessionStorage.getItem("maPhieuDangKy");
                if (!maPhieuDangKy) {
                    alert("‚ùå Kh√¥ng t√¨m th·∫•y m√£ phi·∫øu ƒëƒÉng k√Ω. Vui l√≤ng ƒëƒÉng k√Ω l·∫°i.");
                    return;
                }

                const maLichThi = parseInt(selected.value);
                const loaiChungChi = parseInt(selected.getAttribute("data-loaichungchi"));
                const thoiGianThi = selected.getAttribute("data-thoigian");

                try {
                    const res = await fetch("/api/xacNhanLichThi", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            maPhieuDangKy: parseInt(maPhieuDangKy),
                            maLichThi,
                            loaiChungChi,
                            thoiGianThi
                        })
                    });

                    const result = await res.json();
                    if (result.message) {
                        alert("‚úÖ " + result.message);
                        sessionStorage.removeItem("maPhieuDangKy");
                        window.location.href = "/InPhieuDangKy/InPhieuDangKy.html";
                    } else {
                        alert("‚ùå " + result.error);
                    }
                } catch (err) {
                    console.error("L·ªói x√°c nh·∫≠n l·ªãch:", err);
                    alert("‚ùå L·ªói k·∫øt n·ªëi t·ªõi m√°y ch·ªß.");
                }
            });

            radios.forEach(r => r.addEventListener("change", () => {
                searchBox.value = "";
                fetchData(r.value);
            }));

            searchBtn.addEventListener("click", () => {
                const keyword = searchBox.value.trim();
                const selectedRadio = document.querySelector("input[name='filter']:checked");
                const filter = keyword ? "" : selectedRadio?.value || "all";
                fetchData(filter, keyword);
            });

            searchBox.addEventListener("keypress", e => {
                if (e.key === "Enter") searchBtn.click();
            });

            fetchData("all");

            fetch('/DangNhap/Navbar.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('navbar-container').innerHTML = html;
                    checkLoginStatus();
                });
        });
    </script>
</body>

</html>